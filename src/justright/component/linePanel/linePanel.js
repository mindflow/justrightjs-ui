import { Logger, Method } from "coreutil_v1";
import { InjectionPoint, Provider } from "mindi_v1";
import { Component, ComponentFactory, CanvasStyles, EventManager, StateManager } from "justright_core_v1";
import { Panel } from "../panel/panel.js";
import { LinePanelEntry } from "./treePanelEntry/linePanelEntry.js";
import { ContainerEvent } from "containerbridge_v1";

const LOG = new Logger("LinePanel");

export class LinePanel {

	static COMPONENT_NAME = "LinePanel";
	static TEMPLATE_URL = "/assets/justrightjs-ui/linePanel.html";
	static STYLES_URL = "/assets/justrightjs-ui/linePanel.css";

	static EVENT_REFRESH_CLICKED = "refreshClicked";
	static RECORD_ELEMENT_REQUESTED = "recordElementRequested";
	static RECORDS_STATE_UPDATE_REQUESTED = "recordsStateUpdateRequested";

	/**
	 * 
	 * @param {Panel} buttonPanel 
	 */
	constructor(buttonPanel = null) {

		/** @type {ComponentFactory} */
		this.componentFactory = InjectionPoint.instance(ComponentFactory);
		
		/** @type {Component} */
		this.component = null;

		/** @type {EventManager} */
		this.eventManager = new EventManager();

		/** @type {Provider<LinePanelEntry>} */
		this.linePanelEntryProvider = InjectionPoint.provider(LinePanelEntry);

		/** @type {Provider<Panel>} */
		this.panelProvider = InjectionPoint.provider(Panel);

        /** @type {StateManager<any[]>} */
        this.arrayState = InjectionPoint.instance(StateManager);

		/** @type {Panel} */
		this.buttonPanel = buttonPanel;

	}

	async postConfig() {
		this.component = this.componentFactory.create(LinePanel.COMPONENT_NAME);
		CanvasStyles.enableStyle(LinePanel.COMPONENT_NAME);

		if (this.buttonPanel) {
			this.component.setChild("buttonPanel", this.buttonPanel.component);
		}

		this.arrayState.react(new Method(this, this.handleArrayState));


	}

	/**
	 * @type { EventManager }
	 */
	get events() { return this.eventManager; }

	/**
	 * @type { EventManager }
	 */
	get events() { return this.eventManager; }

	/**
	 * Reset
	 * 
	 * @param {ContainerEvent} event 
	 */
	async reset(event) {
		this.events.trigger(LinePanel.RECORDS_STATE_UPDATE_REQUESTED, [event, this.arrayState]);
	}

    /**
     * @param {Array} array 
     */
    async handleArrayState(array) {
		const panel = await this.panelProvider.get([
			Panel.PARAMETER_STYLE_TYPE_COLUMN, 
			Panel.PARAMETER_STYLE_CONTENT_ALIGN_LEFT, 
			Panel.PARAMETER_STYLE_SIZE_MINIMAL]);
		array.forEach(async (record) => {
            await this.populateRecord(panel, record);
        });

		this.component.setChild("recordElements", panel.component);
    }

	    /**`
	 * @param {Component} panel
     * @param {any} record 
     */
    async populateRecord(panel, record) {
        const recordElement = await this.eventManager.trigger(LinePanel.RECORD_ELEMENT_REQUESTED, [null, record]);
        
		if (!recordElement) {
			return;
		}

		const linePanelEntry = await this.linePanelEntryProvider.get([true, record]);
		linePanelEntry.component.setChild("recordElement", recordElement.component);

		panel.component.addChild("panel", linePanelEntry.component);
    }
}